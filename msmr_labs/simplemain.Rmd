---
title: "Simple Effects, Main Effects, Contrasts"
bibliography: references.bib
biblio-style: apalike
link-citations: yes
params: 
    SHOW_SOLS: TRUE
    TOGGLE: TRUE
editor_options: 
  chunk_output_type: console
---


```{r include=FALSE}
source('assets/setup.R')
library(tidyverse)
library(patchwork)
# make the data
set.seed(093)
expand_grid(
  group = rep(c("GroupA","GroupB"), each=20),
  condition = c(1,2)
) -> df
# make the outcome
#- intercept is 10,   
#- groupB effect is 5,   
#- condition2 effect is -5  
#- interaction- cond2:groupB is 5  
#- plus some noise sd 5  

df$y <- 10 + 
  ((df$group=="GroupB")*5) + 
  ((df$condition==2)*-5) + 
  ((df$condition==2 & df$group=="GroupB")*5) + 
  rnorm(nrow(df),0,5)
df$condition <- paste0("condition",df$condition)
#shuffle
df <- sample_n(df, n()) %>% select(y, group, condition)

datplot <- ggplot(df, aes(x=condition, y=y, col=group))+
  geom_jitter(width=.1, alpha=.4) +
  geom_boxplot(alpha=.5)+
  #stat_summary(aes(group=group), geom="path")+
  #stat_summary(aes(label=interaction(group,condition)),geom="label", size=2)+
  guides(col="none")+
  labs(title="The data")+ylim(-5,25)
model <- lm(y~condition*group, df)
modplot <- as.data.frame(effects::effect("condition*group",model)) %>%
  ggplot(.,aes(x=condition, y=fit, ymin=lower,ymax=upper, col=group))+
  geom_pointrange() +
  labs(title="The model", subtitle="lm(y ~ condition * group)")+ylim(-5,25)
```

# Setup

Suppose we conduct an experiment in which there are two conditions (1 and 2) and there are two groups of people (A and B).  

```{r echo=FALSE}
datplot
```


We want to examine whether there are differences between conditions in our outcome variable, Y, whether there are group differences in our outcome, and whether the difference in conditions is different between our two groups A and B.   
This leads us to fit the following model:  
$$
y = \beta_0 + \beta_1(\text{Group}) + \beta_2(\text{Condition}) + \beta_3(\text{Group}\times \text{Condition}) + \varepsilon
$$
What we are going to discuss here is how we can change what our estimated coefficients ($\beta_0, \beta_1, \beta_2, \beta_3$) represent, by changing the way in which `Group` and `Condition` are encoded.  

:::statbox
__No matter how we encode these categorical predictors, the model stays the same. We are simply extracting different estimates from it__
:::

Our model fitted values are plotted below:  
```{r echo=FALSE}
modplot
```

:::statbox
__"contrasts"__  

One last thing that we need to be aware of is that categorical variables, in R, have a feature called "contrasts", which designates how they get encoded into a model.  
```{r echo=FALSE}
df$group = factor(df$group)
df$condition = factor(df$condition)
```

We can see the contrasts quickly like so:  
```{r}
contrasts(df$condition)
```

The columns will correspond to the predictors that will be inputted into our model, and the rows show what each level will correspond to (in this case, a 0 or a 1).   

__Important:__ Your variable _must_ be a factor in order for `contrasts()` to show you anything. 
```{r error=T}
catvar <- c("cat","cat","dog","cat","dog","cat")
contrasts(catvar)
catvar <- factor(catvar)
contrasts(catvar)
```

:::

# "Treatment" Contrasts (the default)

R's default way of treating factors is to have contrasts where one level is the reference level, and we model each other level compared to this reference level.  

We can see this by looking at the contrasts:  
```{r}
contrasts(df$group)
contrasts(df$condition)
```


In our case, think about what moving from 0 to 1 represents. We are essentially fitting the model: 
When we have our model, to work out what each coefficient represents, we need to think about:

a. What group and condition is represented when both the group contrast and the condition contrast are 0?  
  __Answer:__ Group A, Condition 1
b. What is represented by a change from 0 to 1 in the group contrast?  
  __Answer:__ Moving from Group A to Group B
c. What is represented by a change from 0 to 1 in the condition contrast?  
  __Answer:__ Moving from Condition 1 to Condition 2

```{r echo=FALSE}
as.data.frame(effects::effect("condition*group",model)) %>%
  ggplot(.,aes(x=condition, y=fit, ymin=lower,ymax=upper, col=group))+
  geom_pointrange(size=1.3, alpha=.5) +
  labs(title="The model", subtitle="lm(y ~ condition * group)")+ylim(-5,25)
```


```{r}
as.data.frame(effects::effect("condition*group",model)) %>%
  ggplot(.,aes(x=condition, y=fit, ymin=lower,ymax=upper, col=group))+
  geom_pointrange(size=1.3, alpha=.5) +
  labs(title="The model", subtitle="lm(y ~ condition * group)")+ylim(-5,25)+
  geom_point(inherit.aes=FALSE, aes(x=1,y=coef(model)[1]),size=3)+
  geom_segment(inherit.aes=FALSE, aes(x=1,xend=2,y=coef(model)[1],yend=sum(coef(model)[1:2])))+
  geom_segment(inherit.aes=FALSE, aes(x=1,xend=1,y=coef(model)[1],yend=sum(coef(model)[c(1,3)])))+
  #interaction
  geom_segment(inherit.aes=FALSE, aes(x=1.02,xend=1.02,y=coef(model)[1],yend=sum(coef(model)[c(1,3)])),lty="dotted")+
  geom_segment(inherit.aes=FALSE, aes(x=1,xend=2,y=sum(coef(model)[c(1,3)]),yend=sum(coef(model)[c(1:3)])),lty="dotted")+
  geom_segment(inherit.aes=FALSE, aes(x=2,xend=2,y=sum(coef(model)[1:3]),yend=sum(coef(model)[c(1:4)])))
```




```{r}
#balanced
model1 <- lm(formula = y ~ condition * group, data = df)
model2 <- lm(formula = y ~ condition * group, data = df,
             contrasts=list(group="contr.sum",condition="contr.sum"))

car::Anova(model2, type="III")
anova(model2)
coef(summary(model2))[,3]^2

car::Anova(model1, type="III")
anova(model1)
coef(summary(model1))[,3]^2

# unbalanced
model1 <- lm(formula = y ~ condition * group, data = df2)
model2 <- lm(formula = y ~ condition * group, data = df2,
             contrasts=list(group="contr.sum",condition="contr.sum"))

car::Anova(model2, type="III")
anova(model2)
coef(summary(model2))[,3]^2

car::Anova(model1, type="III")[,"F value"]
anova(model1)[,"F value"]
coef(summary(model1))[,3]^2
```

