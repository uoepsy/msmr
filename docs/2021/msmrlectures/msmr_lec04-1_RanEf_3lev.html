<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Week 4, part 1: Three-Level Nesting</title>
    <meta charset="utf-8" />
    <meta name="author" content="Dan Mirman" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# <b>Week 4, part 1: Three-Level Nesting</b>
## Multivariate Statistics and Methodology using R (MSMR)<br><br>
### Dan Mirman
### Department of Psychology<br>The University of Edinburgh
### AY 2020-2021

---






# Turtles all the way down
.pull-left[
MLM is useful for **nested data**. 

So far, we've considered two levels of nesting:

* Group level
* Individual level

It's also possible to have multiple nesting levels or other kinds of crossed nesting structures.

This is captured by the **random effect structure**.
]

.pull-right[
&lt;img src="./figs/turtles_wikipedia.jpg" /&gt;

image credit: wikipedia
]

---
# 3-level nesting

.left-column[
**Sources of variability (random intercepts and time-slopes)**

* Therapists 
* Subjects
]

.right-column[
&lt;img src="./figs/3lvl_rpsychologist.png" /&gt;

image credit: Kristoffer Magnusson
]

---
# Example: Math Active Learning
**Simulated example: Testing whether a new (computer based) active learning method improves math test scores.** 

* You measured students' math scores (DV) and the proportion of time (IV) they spent using the computer. 
* The program was implemented in 3 schools
* 8-12 classrooms in each school (total schools n=30)
* 12-24 students per class (total students n=570)

&lt;img src="./figs/3lvl_math.png" /&gt;

image credit: Alexander P. Demos

---
# Math Active Learning: Read the data

Do a little data wrangling: center some values relative to the grand mean and the school mean.


```r
math &lt;- read_csv("./data/active_math_sim.csv") %&gt;%
  mutate(Class = paste0(School, "cl", Classroom), #unique class ID
         ActiveTime.GM = scale(ActiveTime, scale=F), #grand-mean centered
         ClassSize.GM = scale(ClassSize, scale=F)) %&gt;% #grand-mean centered
  group_by(School) %&gt;%
  mutate(ClassSize.SM = scale(ClassSize, scale=F)) #school-mean centered
```

```
## Parsed with column specification:
## cols(
##   Math = col_double(),
##   ActiveTime = col_double(),
##   ClassSize = col_double(),
##   Classroom = col_double(),
##   School = col_character(),
##   StudentID = col_double()
## )
```

---
# Math Active Learning: Exploratory plot 1


```r
p1a &lt;- ggplot(math, aes(ClassSize, Math)) + geom_point() + geom_smooth(method = "lm")
p1b &lt;- ggplot(math, aes(ActiveTime, Math)) + geom_point() + geom_smooth(method = "lm")
p1a + p1b # requires "patchwork" library
```

![](msmr_lec04-1_RanEf_3lev_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;

Looks like math scores are better in **smaller classes** and for students with a higher **active learning proportion**.

---
# Math Active Learning: Exploratory plot 2


```r
p2a &lt;- ggplot(math, aes(Class, ClassSize, color=School)) + geom_point() + coord_flip()
p2b &lt;- ggplot(math, aes(Class, ActiveTime, fill=School)) + geom_boxplot() + coord_flip()
p2a + p2b
```

![](msmr_lec04-1_RanEf_3lev_files/figure-html/unnamed-chunk-3-1.png)&lt;!-- --&gt;

* Classes differ in size, and this is unequal across schools
* Students differ in proportion  of time spent on active learning, but each class has a big (similar) range

---
# Math Active Learning: 2-level model


```r
m1 &lt;- lmer(Math ~ ActiveTime.GM * ClassSize.GM + (1 | Class),  
          data=math, REML=FALSE)
gt(tidy(m1)) # requires "broom.mixed" and "gt" packages
```

<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#sviclajwtf .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#sviclajwtf .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sviclajwtf .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#sviclajwtf .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#sviclajwtf .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sviclajwtf .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sviclajwtf .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#sviclajwtf .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#sviclajwtf .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#sviclajwtf .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#sviclajwtf .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#sviclajwtf .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#sviclajwtf .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#sviclajwtf .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#sviclajwtf .gt_from_md > :first-child {
  margin-top: 0;
}

#sviclajwtf .gt_from_md > :last-child {
  margin-bottom: 0;
}

#sviclajwtf .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#sviclajwtf .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#sviclajwtf .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sviclajwtf .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#sviclajwtf .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sviclajwtf .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#sviclajwtf .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sviclajwtf .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sviclajwtf .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#sviclajwtf .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sviclajwtf .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#sviclajwtf .gt_left {
  text-align: left;
}

#sviclajwtf .gt_center {
  text-align: center;
}

#sviclajwtf .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#sviclajwtf .gt_font_normal {
  font-weight: normal;
}

#sviclajwtf .gt_font_bold {
  font-weight: bold;
}

#sviclajwtf .gt_font_italic {
  font-style: italic;
}

#sviclajwtf .gt_super {
  font-size: 65%;
}

#sviclajwtf .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="sviclajwtf" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">effect</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">group</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">df</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">p.value</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">(Intercept)</td>
      <td class="gt_row gt_right">42.9645</td>
      <td class="gt_row gt_right">1.5858</td>
      <td class="gt_row gt_right">27.093</td>
      <td class="gt_row gt_right">29.93</td>
      <td class="gt_row gt_right">1.291e-22</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">ActiveTime.GM</td>
      <td class="gt_row gt_right">14.9057</td>
      <td class="gt_row gt_right">0.6044</td>
      <td class="gt_row gt_right">24.662</td>
      <td class="gt_row gt_right">540.66</td>
      <td class="gt_row gt_right">1.509e-90</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">ClassSize.GM</td>
      <td class="gt_row gt_right">-1.8662</td>
      <td class="gt_row gt_right">0.4805</td>
      <td class="gt_row gt_right">-3.884</td>
      <td class="gt_row gt_right">30.05</td>
      <td class="gt_row gt_right">5.244e-04</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">ActiveTime.GM:ClassSize.GM</td>
      <td class="gt_row gt_right">0.3613</td>
      <td class="gt_row gt_right">0.1939</td>
      <td class="gt_row gt_right">1.863</td>
      <td class="gt_row gt_right">540.59</td>
      <td class="gt_row gt_right">6.300e-02</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">sd__(Intercept)</td>
      <td class="gt_row gt_right">8.5091</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Residual</td>
      <td class="gt_row gt_left">sd__Observation</td>
      <td class="gt_row gt_right">4.1709</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
  </tbody>
  
  
</table></div>

--

As we work through this example, keep an eye on the effect of class size and its interaction with active learning time.

---
# Math Active Learning: 2-level model fit(s)

```r
ggplot(augment(m1), aes(ActiveTime.GM, Math, color=Class)) +
  geom_point() + geom_smooth(aes(y=.fitted), method = "lm") +
  xlab("Active Learning Time") + ylab("Math Score") + theme(legend.position = "none")
```

![](msmr_lec04-1_RanEf_3lev_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;

Note the parallel lines: Our model allows classrooms to differ in math scores (random intercept), but not in the effect of active learning, which is assumed to be the same in all classrooms.

--

Maybe classes differ in how strongly active learning influences math achievement? **Add random slopes**

---
# Math Active Learning: 2-level model, part 2

```r
m2 &lt;- lmer(Math ~ ActiveTime.GM * ClassSize.GM + (1 + ActiveTime.GM | Class), data=math, REML=F)
```
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#elgblpvzck .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#elgblpvzck .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#elgblpvzck .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#elgblpvzck .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#elgblpvzck .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#elgblpvzck .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#elgblpvzck .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#elgblpvzck .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#elgblpvzck .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#elgblpvzck .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#elgblpvzck .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#elgblpvzck .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#elgblpvzck .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#elgblpvzck .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#elgblpvzck .gt_from_md > :first-child {
  margin-top: 0;
}

#elgblpvzck .gt_from_md > :last-child {
  margin-bottom: 0;
}

#elgblpvzck .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#elgblpvzck .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#elgblpvzck .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#elgblpvzck .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#elgblpvzck .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#elgblpvzck .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#elgblpvzck .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#elgblpvzck .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#elgblpvzck .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#elgblpvzck .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#elgblpvzck .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#elgblpvzck .gt_left {
  text-align: left;
}

#elgblpvzck .gt_center {
  text-align: center;
}

#elgblpvzck .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#elgblpvzck .gt_font_normal {
  font-weight: normal;
}

#elgblpvzck .gt_font_bold {
  font-weight: bold;
}

#elgblpvzck .gt_font_italic {
  font-style: italic;
}

#elgblpvzck .gt_super {
  font-size: 65%;
}

#elgblpvzck .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="elgblpvzck" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">effect</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">group</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">df</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">p.value</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">(Intercept)</td>
      <td class="gt_row gt_right">42.8612</td>
      <td class="gt_row gt_right">1.5984</td>
      <td class="gt_row gt_right">26.815</td>
      <td class="gt_row gt_right">29.95</td>
      <td class="gt_row gt_right">1.715e-22</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">ActiveTime.GM</td>
      <td class="gt_row gt_right">14.8927</td>
      <td class="gt_row gt_right">1.0450</td>
      <td class="gt_row gt_right">14.251</td>
      <td class="gt_row gt_right">30.32</td>
      <td class="gt_row gt_right">5.614e-15</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">ClassSize.GM</td>
      <td class="gt_row gt_right">-1.8703</td>
      <td class="gt_row gt_right">0.4843</td>
      <td class="gt_row gt_right">-3.862</td>
      <td class="gt_row gt_right">30.04</td>
      <td class="gt_row gt_right">5.561e-04</td>
    </tr>
    <tr>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">fixed</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">NA</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">ActiveTime.GM:ClassSize.GM</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.3329</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.3263</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">1.020</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">33.11</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">3.150e-01</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">sd__(Intercept)</td>
      <td class="gt_row gt_right">8.5821</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">cor__(Intercept).ActiveTime.GM</td>
      <td class="gt_row gt_right">-0.3107</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">sd__ActiveTime.GM</td>
      <td class="gt_row gt_right">4.7109</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
  </tbody>
  
  
</table></div>

Adding `ActiveTime` random slopes substantially increased the SE and reduced estimated df for `ActiveTime` fixed effects. Interaction effect is not even marginal in this model: in the first model, omitting the random slope made the corresponding fixed effect anti-conservative.

--

Now that we have that random slope, the model can capture *random* classroom-level variation in effect of active learning instead of spuriously assigning it to class.

---
#  Math Active Learning: 2-level model, part 2 fit(s)

```r
ggplot(augment(m2), aes(ActiveTime.GM, Math, color=Class)) +
  geom_point() + geom_smooth(aes(y=.fitted), method = "lm") +
  xlab("Active Learning Time") + ylab("Math Score") + theme(legend.position = "none")
```

![](msmr_lec04-1_RanEf_3lev_files/figure-html/unnamed-chunk-8-1.png)&lt;!-- --&gt;

Model captures random class-level variation in math scores and strength of active learning effect.

---
#  Math Active Learning: a 3-level model?

The 2-level model assumes that classrooms are independent, but this is not quite true. Classrooms are nested within schools and there may be school-level differences in math scores, effects of active learning, class size, etc.


```r
ggplot(math, aes(ActiveTime.GM, Math, color=Class)) +
  facet_wrap(~ School) +
  geom_point() + geom_smooth(method = "lm", se=FALSE) +
  xlab("Active Learning Time") + ylab("Math Score") + theme(legend.position = "none")
```

![](msmr_lec04-1_RanEf_3lev_files/figure-html/unnamed-chunk-9-1.png)&lt;!-- --&gt;

---
##  School and Class Size are confounded


```r
unique(select(math, School, Class, ClassSize, ClassSize.GM, ClassSize.SM)) %&gt;%
  pivot_longer(cols=starts_with("ClassSize"), names_to = "Type", values_to = "Size") %&gt;%
  ggplot(aes(School, Size)) + facet_wrap(~ Type, scales="free_y") + geom_violin() + geom_jitter(width=0.1, height=0)
```

![](msmr_lec04-1_RanEf_3lev_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;

* Class sizes are different across schools, which means that these variables are confounded: can't distinguish (random, uninteresting) differences between schools from (systematic, interesting) effects of class size.
* This is true for both raw and grand-mean-centered class sizes
* School-mean-centered class sizes allow testing effect of class size while controlling for school-level differences

---
# Sidebar: Simpson's Paradox

.pull-left[
&lt;img src="./figs/Simpsons_paradox.png" /&gt;
]

.pull-right[
**Famous real-world example: gender bias in PG admissions at University of California - Berkeley in 1973**

* Overall acceptance rate higher for males than females
* But individual department acceptance rates higher for females than males

This is usually because of a "lurking" (confounding) variable. In the Berkeley example there is a confound between gender differences in **application** rates and **department** differences in acceptance rates: departments with low admission rates had many more female applicants, departments with higher admission rates had many more male applicants. As a result, even though (almost) all departments had higher acceptance rates for females, the *overall* acceptance rate was higher for males.
]

--

**Lesson**: watch out for sub-group (cluster-level) differences that might be confounded with your variables of interest.

---
#  Math Active Learning: 3-level model

* Use school-mean-centered measure of class size to test effect of class size while controlling for school-level differences
* Add random effect of School (intercept and slope)


```r
m3 &lt;- lmer(Math ~ ActiveTime.GM * ClassSize.SM +
           (1 + ActiveTime.GM | School) +
           (1 + ActiveTime.GM | Class),  
           data=math, REML=FALSE)
```

---
#  Math Active Learning: 3-level model

<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#uaxtdpmhvc .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#uaxtdpmhvc .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uaxtdpmhvc .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#uaxtdpmhvc .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#uaxtdpmhvc .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uaxtdpmhvc .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uaxtdpmhvc .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#uaxtdpmhvc .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#uaxtdpmhvc .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#uaxtdpmhvc .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#uaxtdpmhvc .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#uaxtdpmhvc .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#uaxtdpmhvc .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#uaxtdpmhvc .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#uaxtdpmhvc .gt_from_md > :first-child {
  margin-top: 0;
}

#uaxtdpmhvc .gt_from_md > :last-child {
  margin-bottom: 0;
}

#uaxtdpmhvc .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#uaxtdpmhvc .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#uaxtdpmhvc .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uaxtdpmhvc .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#uaxtdpmhvc .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uaxtdpmhvc .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#uaxtdpmhvc .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uaxtdpmhvc .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uaxtdpmhvc .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#uaxtdpmhvc .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uaxtdpmhvc .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#uaxtdpmhvc .gt_left {
  text-align: left;
}

#uaxtdpmhvc .gt_center {
  text-align: center;
}

#uaxtdpmhvc .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#uaxtdpmhvc .gt_font_normal {
  font-weight: normal;
}

#uaxtdpmhvc .gt_font_bold {
  font-weight: bold;
}

#uaxtdpmhvc .gt_font_italic {
  font-style: italic;
}

#uaxtdpmhvc .gt_super {
  font-size: 65%;
}

#uaxtdpmhvc .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="uaxtdpmhvc" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">effect</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">group</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">df</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">p.value</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">(Intercept)</td>
      <td class="gt_row gt_right">44.45182</td>
      <td class="gt_row gt_right">4.6669</td>
      <td class="gt_row gt_right">9.52485</td>
      <td class="gt_row gt_right">3.046</td>
      <td class="gt_row gt_right">0.002305</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">ActiveTime.GM</td>
      <td class="gt_row gt_right">14.34849</td>
      <td class="gt_row gt_right">1.8123</td>
      <td class="gt_row gt_right">7.91745</td>
      <td class="gt_row gt_right">3.232</td>
      <td class="gt_row gt_right">0.003197</td>
    </tr>
    <tr>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">fixed</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">NA</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">ClassSize.SM</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-0.03656</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.5729</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-0.06381</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">27.970</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.949572</td>
    </tr>
    <tr>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">fixed</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">NA</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">ActiveTime.GM:ClassSize.SM</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-0.78321</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.4133</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-1.89503</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">32.518</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.067008</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">sd__(Intercept)</td>
      <td class="gt_row gt_right">6.74418</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">cor__(Intercept).ActiveTime.GM</td>
      <td class="gt_row gt_right">0.12462</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">sd__ActiveTime.GM</td>
      <td class="gt_row gt_right">3.60241</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">School</td>
      <td class="gt_row gt_left">sd__(Intercept)</td>
      <td class="gt_row gt_right">7.78182</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">School</td>
      <td class="gt_row gt_left">cor__(Intercept).ActiveTime.GM</td>
      <td class="gt_row gt_right">-1.00000</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">School</td>
      <td class="gt_row gt_left">sd__ActiveTime.GM</td>
      <td class="gt_row gt_right">2.74277</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Residual</td>
      <td class="gt_row gt_left">sd__Observation</td>
      <td class="gt_row gt_right">3.91469</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
  </tbody>
  
  
</table></div>

Effect of Class Size is no longer significant: it was a Simpson's paradox effect (differences between Schools, which are confounded with class size, not effects of class size)

---
#  Math Active Learning: 3-level model

.pull-left[
With only 3 schools, the school-level random effects are probably over-parameterized...

```r
VarCorr(m3)
```

```
##  Groups   Name          Std.Dev. Corr 
##  Class    (Intercept)   6.74          
##           ActiveTime.GM 3.60     0.12 
##  School   (Intercept)   7.78          
##           ActiveTime.GM 2.74     -1.00
##  Residual               3.91
```

Yes, the slope-intercept correlation is -1.00

]

--

.pull-right[
Remove the by-school slope-intercept correlation:


```r
m3a &lt;- lmer(Math ~ ActiveTime.GM * ClassSize.SM +
           (1 + ActiveTime.GM || School) +
           (1 + ActiveTime.GM | Class),  
           data=math, REML=FALSE)
VarCorr(m3a)
```

```
##  Groups   Name          Std.Dev. Corr
##  Class    (Intercept)   6.79         
##           ActiveTime.GM 3.76     0.14
##  School   ActiveTime.GM 2.56         
##  School.1 (Intercept)   7.88         
##  Residual               3.91
```
]
---
#  Math Active Learning: 3-level model
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#tajnhpbrkz .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#tajnhpbrkz .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tajnhpbrkz .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#tajnhpbrkz .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#tajnhpbrkz .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tajnhpbrkz .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tajnhpbrkz .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#tajnhpbrkz .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#tajnhpbrkz .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#tajnhpbrkz .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#tajnhpbrkz .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#tajnhpbrkz .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#tajnhpbrkz .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#tajnhpbrkz .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#tajnhpbrkz .gt_from_md > :first-child {
  margin-top: 0;
}

#tajnhpbrkz .gt_from_md > :last-child {
  margin-bottom: 0;
}

#tajnhpbrkz .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#tajnhpbrkz .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#tajnhpbrkz .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tajnhpbrkz .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#tajnhpbrkz .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tajnhpbrkz .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#tajnhpbrkz .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tajnhpbrkz .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tajnhpbrkz .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#tajnhpbrkz .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tajnhpbrkz .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#tajnhpbrkz .gt_left {
  text-align: left;
}

#tajnhpbrkz .gt_center {
  text-align: center;
}

#tajnhpbrkz .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#tajnhpbrkz .gt_font_normal {
  font-weight: normal;
}

#tajnhpbrkz .gt_font_bold {
  font-weight: bold;
}

#tajnhpbrkz .gt_font_italic {
  font-style: italic;
}

#tajnhpbrkz .gt_super {
  font-size: 65%;
}

#tajnhpbrkz .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="tajnhpbrkz" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">effect</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">group</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">df</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">p.value</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">(Intercept)</td>
      <td class="gt_row gt_right">44.35577</td>
      <td class="gt_row gt_right">4.7261</td>
      <td class="gt_row gt_right">9.38533</td>
      <td class="gt_row gt_right">3.033</td>
      <td class="gt_row gt_right">0.002451</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">fixed</td>
      <td class="gt_row gt_left">NA</td>
      <td class="gt_row gt_left">ActiveTime.GM</td>
      <td class="gt_row gt_right">14.32683</td>
      <td class="gt_row gt_right">1.7365</td>
      <td class="gt_row gt_right">8.25056</td>
      <td class="gt_row gt_right">3.177</td>
      <td class="gt_row gt_right">0.003003</td>
    </tr>
    <tr>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">fixed</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">NA</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">ClassSize.SM</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-0.02766</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.5772</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-0.04792</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">27.226</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.962128</td>
    </tr>
    <tr>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">fixed</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">NA</td>
      <td class="gt_row gt_left" style="background-color: #FFFF00;">ActiveTime.GM:ClassSize.SM</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-0.77926</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.4231</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">-1.84189</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">29.967</td>
      <td class="gt_row gt_right" style="background-color: #FFFF00;">0.075409</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">sd__(Intercept)</td>
      <td class="gt_row gt_right">6.79290</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">cor__(Intercept).ActiveTime.GM</td>
      <td class="gt_row gt_right">0.13698</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Class</td>
      <td class="gt_row gt_left">sd__ActiveTime.GM</td>
      <td class="gt_row gt_right">3.75530</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">School</td>
      <td class="gt_row gt_left">sd__ActiveTime.GM</td>
      <td class="gt_row gt_right">2.55827</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">School.1</td>
      <td class="gt_row gt_left">sd__(Intercept)</td>
      <td class="gt_row gt_right">7.88169</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">ran_pars</td>
      <td class="gt_row gt_left">Residual</td>
      <td class="gt_row gt_left">sd__Observation</td>
      <td class="gt_row gt_right">3.91480</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
  </tbody>
  
  
</table></div>

---
# Key points

Nested structure can extend to 3 (or more) levels and this should be captured in the random effects structure of a multilevel model

This is particularly important when sub-group (cluster-level) differences might be confounded with variables of interest (Simpson's Paradox).

--

Omitting random slopes tends to make models anti-conservative (inflates rates of false positives). **Recommendation:** start with a "full" or "maximal" random effect structure and reduce as needed

--

When there are only a few observational units (e.g., 3 schools), estimating random effects is very difficult (esp. random slopes) and can produce unreliable fixed effect estimates. Over-parameterised random effect structures should be simplified.
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
