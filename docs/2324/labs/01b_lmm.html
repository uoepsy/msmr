<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MSMR - 1B: Linear Mixed Models/Multi-level Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);
e.style.display = ((e.style.display!='none') ? 'none' : 'block');
if(f.classList.contains('fa-circle-right')) {
    f.classList.add('fa-circle-down')
    f.classList.remove('fa-circle-right')
} else {
    f.classList.add('fa-circle-right')
    f.classList.remove('fa-circle-down')
}
}
</script>

<script src="https://kit.fontawesome.com/120b08a6f5.js" crossorigin="anonymous"></script>
<link href="site_libs/panelset-0.2.6/panelset.css" rel="stylesheet">
<script src="site_libs/panelset-0.2.6/panelset.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01a_clustered.html">Week 1</a></li><li class="breadcrumb-item"><a href="./01b_lmm.html">1B: Linear Mixed Models/Multi-level Models</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">MSMR</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Week 1</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01a_clustered.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1A: Clustered Data | LMM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01b_lmm.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1B: Linear Mixed Models/Multi-level Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Additional Docs</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_lm_assumpt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LM Troubleshooting</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#fixed-effects" id="toc-fixed-effects" class="nav-link active" data-scroll-target="#fixed-effects">Fixed effects</a></li>
  <li><a href="#the-multi-level-model" id="toc-the-multi-level-model" class="nav-link" data-scroll-target="#the-multi-level-model">The multi-level model</a>
  <ul class="collapse">
  <li><a href="#random-intercept" id="toc-random-intercept" class="nav-link" data-scroll-target="#random-intercept">random intercept</a></li>
  <li><a href="#random-slopes" id="toc-random-slopes" class="nav-link" data-scroll-target="#random-slopes">random slopes</a></li>
  <li><a href="#partial-pooling" id="toc-partial-pooling" class="nav-link" data-scroll-target="#partial-pooling">partial pooling</a></li>
  </ul></li>
  <li><a href="#fitting-multilevel-models-in-r" id="toc-fitting-multilevel-models-in-r" class="nav-link" data-scroll-target="#fitting-multilevel-models-in-r">fitting multilevel models in R</a>
  <ul class="collapse">
  <li><a href="#model-parameters" id="toc-model-parameters" class="nav-link" data-scroll-target="#model-parameters">model parameters</a></li>
  <li><a href="#cluster-predictions" id="toc-cluster-predictions" class="nav-link" data-scroll-target="#cluster-predictions">cluster predictions</a></li>
  </ul></li>
  <li><a href="#model-estimation" id="toc-model-estimation" class="nav-link" data-scroll-target="#model-estimation">model estimation</a>
  <ul class="collapse">
  <li><a href="#ml-and-reml" id="toc-ml-and-reml" class="nav-link" data-scroll-target="#ml-and-reml">ML and REML</a></li>
  <li><a href="#convergence-issues" id="toc-convergence-issues" class="nav-link" data-scroll-target="#convergence-issues">convergence issues</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">1B: Linear Mixed Models/Multi-level Models</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>The methods we’re going to start to look at are known by lots of different names (see <a href="#fig-wordcloud">Figure&nbsp;1</a>). The core idea is that <strong>model parameters vary at more than one level.</strong>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-wordcloud" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01b_lmm_files/figure-html/fig-wordcloud-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: size weighted by hits on google scholar search (sept 2020)</figcaption>
</figure>
</div>
</div>
</div>
<div class="divider div-transparent div-dot">

</div>
<section id="fixed-effects" class="level1">
<h1>Fixed effects</h1>
<p>In the simple linear regression model was written as <span class="math inline">\(\color{red}{y} = \color{blue}{b_0 + b_1x_1 \ + \ ... \ + \ b_px_p} \color{black}{\ + \ \varepsilon}\)</span>, the estimated coefficients <span class="math inline">\(\color{blue}{b_0}\)</span>, <span class="math inline">\(\color{blue}{b_1}\)</span> etc., are estimated as <strong>fixed</strong> values - i.e.&nbsp;we estimate just one number for <span class="math inline">\(b_0\)</span>, and one number for <span class="math inline">\(b_1\)</span>, for <span class="math inline">\(b_2\)</span> and so on, and that’s it.</p>
<p>In the example where we model School children’s grades as a function of their motivation score, when we fit a simple regression model of <code>lm(grade ~ motiv)</code>, the estimated parameters are two values that define a line - an intercept and a slope (as in <a href="#fig-schoolplot1">Figure&nbsp;2</a>).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-schoolplot1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01b_lmm_files/figure-html/fig-schoolplot1-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Grade predicted by motivation. The simple linear regression model defines the height and slope of the black line.</figcaption>
</figure>
</div>
</div>
</div>
<p>The intercept and slope here are ‘fixed’ in the sense that it does not matter what school a child is from, if they score 0 on the motivation scale, then our model predicts that they will get a grade of 40.3 (the intercept).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>schoolmot <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/schoolmot.csv"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>srmod <span class="ot">&lt;-</span> <span class="fu">lm</span>(grade <span class="sc">~</span> motiv, <span class="at">data =</span> schoolmot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>...
Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  40.2776     1.8270  22.046  &lt; 2e-16 ***
motiv         1.9551     0.3422   5.714  1.5e-08 ***
---</code></pre>
</div>
</div>
<p>To make this point really clear, we can write our model equation with the addition of a suffix <span class="math inline">\(i\)</span> to indicate that the equation for the <span class="math inline">\(i^{th}\)</span> child is:</p>
<p><span class="math display">\[
\begin{align}
&amp;\text{For child }i \\
&amp;\text{grade}_i = b_0 + b_1 \cdot \text{motiv}_i + \epsilon_i
\end{align}
\]</span> i.e.&nbsp;For any child <span class="math inline">\(i\)</span> that we choose, that child’s grade (<span class="math inline">\(\text{grade}_i\)</span>) is some fixed number (<span class="math inline">\(b_0\)</span>) plus some fixed amount (<span class="math inline">\(b_1\)</span>) times that child’s motivation (<span class="math inline">\(\text{motiv}_i\)</span>).</p>
<p>The issue, as we saw in <a href="01a_clustered.html#clustered-data">1A #clustered-data</a>, is that the children in our study are actually related to one another in that they can be grouped into the schools that we sampled them from. It’s entirely possible (and likely) that there are school-level differences might actually account for quite a lot of the variation in grades (in <a href="01a_clustered.html#icc---quantifying-clustering-in-an-outcome-variable">1A #ICC</a> we actually estimated this to account for approx 40% of the variation in grades).</p>
<p>TODO CHECK below</p>
<p>We saw how we might add in <code>school</code> as a predictor to our linear model to estimate all these school-level differences (<code>lm(grade ~ schoolid + motiv)</code>). This is a good start, and may oftentimes be perfectly acceptable if our clustering is simply a nuisance thing that we want to account for - adding in the clustering as another predictor will completely account for <em>all</em> cluster-level variability in our outcome variable.</p>
<p>However, more frequently these clusters are themselves additional units of observation that have features of interest to us. For instance, we may be interested in how the funding that a school receives moderates the association between childrens motivation and grades - i.e.&nbsp;we’re interested in things that happen both at the child-level (motivation, grades), and at the school-level (funding). For these scenarios, we really need a multilevel model.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
clusters as fixed effects
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We have already seen that we can include fixed effects for cluster differences (we referred to this as “no pooling”).</p>
<p>e.g.&nbsp;to fit school-level differences in grades, we could use:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>femod <span class="ot">&lt;-</span> <span class="fu">lm</span>(grade <span class="sc">~</span> motiv <span class="sc">+</span> schoolid, <span class="at">data =</span> schoolmot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model equation for this would look something like: <span class="math display">\[
\begin{align}
\text{For child }i&amp; \\
\text{grade}_i =\, &amp;b_0 + b_1 \cdot \text{motiv}_i + b_2 \cdot \text{isSchool2}_i + b_3 \cdot \text{isSchool3}_i\,\, + \,\, ... \,\, + \\
&amp; ... + \,\, ... \,\, + \,\, ... \,\, + \\
&amp; b_p \cdot \text{isSchoolP}_i\,\, + \epsilon_i
\end{align}
\]</span></p>
<p>The school coefficients are a series of dummy variables that essentially toggle on or off depending on which school child <span class="math inline">\(i\)</span> is from.</p>
<p>Because these set of coefficients accoutn for <strong>all</strong> of the school-level differences in grades, it means we are then unable to consider other school-level variables like <code>funding</code> (how much govt funding the school receives). If we try, we can see that a coefficient for <code>funding</code> is not able to be estimated because <code>schoolid</code> is explaining everything school-related:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>femod2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(grade <span class="sc">~</span> motiv <span class="sc">+</span> schoolid <span class="sc">+</span> funding, <span class="at">data =</span> schoolmot)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(femod2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Coefficients: (1 not defined because of singularities)
                                   Estimate  Std. Error  t value  Pr(&gt;|t|)    
(Intercept)                        36.2655      2.5667    14.129   &lt; 2e-16 ***
motiv                              1.5723       0.3673    4.281   2.07e-05 ***
schoolidBalfron High School        1.0683       2.8923    0.369   0.711946 
schoolidBanff Academy             -3.3253       2.9142   -1.141   0.254163 
...                                ...          ...       ...     ... 
...                                ...          ...       ...     ... 
funding                            NA           NA        NA      NA  </code></pre>
</div>
</div>
</div>
<div class="divider div-transparent div-dot">

</div>
</section>
<section id="the-multi-level-model" class="level1">
<h1>The multi-level model</h1>
<p>The multi-level model is an alternative model structure that accounts for cluster-level differences in a more flexible and parsimonious way. It achieves this by taking some of the estimated coefficients <span class="math inline">\(b_?\)</span> in our linear regression model and modelling these as randomly varying by clusters (i.e.&nbsp;each cluster gets its own value of <span class="math inline">\(b_?\)</span>).</p>
<p>Let’s see how this works by starting with the intercept, <span class="math inline">\(b_0\)</span>.</p>
<section id="random-intercept" class="level2">
<h2 class="anchored" data-anchor-id="random-intercept">random intercept</h2>
<p>To extend the single-level regression model to the multi-level regression model, we add in an extra suffix to our equation to indicate which cluster an observation belongs to.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Then, we can take our coefficients <span class="math inline">\(b_?\)</span> and allow them to be different for each cluster <span class="math inline">\(i\)</span> by adding the suffix <span class="math inline">\(b_{?i}\)</span>. Below, we have done this for our intercept <span class="math inline">\(b_0\)</span>.</p>
<p>However, we also need to <em>define</em> these differences, and the multilevel model does this by expressing each cluster’s intercept as a deviation (<span class="math inline">\(\zeta_{0i}\)</span> for cluster <span class="math inline">\(i\)</span>, below) from a fixed number (<span class="math inline">\(\gamma_{00}\)</span>, below). Because these differences are to do with the <em>clusters</em> (and not the individual observations within them), we often write these as a “level 2 equation”:</p>
<p><span class="math display">\[
\begin{align}
\text{For observation }j&amp;\text{ in cluster }i \\
\text{Level 1:}&amp; \\
y_{ij} &amp;= b_{0i} + b_1 \cdot x_{ij} + \epsilon_{ij} \\
\text{Level 2:}&amp; \\
b_{0i} &amp;= \gamma_{00} + \zeta_{0i} \\
\end{align}
\]</span></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
mixed-effects notation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Instead of writing several equations at multiple levels, we substitute the Level 2 terms into the Level 1 equation to get something that is longer, but all in one:</p>
<p><span class="math display">\[
\color{red}{y_{ij}} = \underbrace{(\gamma_{00} + \color{orange}{\zeta_{0i}})}_{\color{blue}{b_{0i}}} \cdot 1 + \color{blue}{b_{1}} \cdot x_{ij}  +  \varepsilon_{ij}
\]</span></p>
<p>This notation typically corresponds with the “mixed effects” terminology because parameters can now be a combination of both a fixed number and a random deviation, as in the intercept below:</p>
<p><span class="math display">\[
\color{red}{y_{ij}} = \underbrace{(\underbrace{\gamma_{00}}_{\textrm{fixed}} + \color{orange}{\underbrace{\zeta_{0i}}_{\textrm{random}}})}_{\text{intercept, }b_{0i}} \cdot 1 + \underbrace{b_2}_{\textrm{fixed}} \cdot x_{ij} +  \varepsilon_{ij}
\]</span></p>
</div>
</div>
</div>
<p>Returning to our school children’s grade example, we can fit a model with “random intercepts for schools”, which would account for the possibility that some schools have higher grades, some have lower grades, etc.</p>
<p><span class="math display">\[
\begin{align}
\text{For Child }j\text{ in School }i&amp; \\
\text{Level 1 (child):}&amp; \\
\text{grade}_{ij} &amp;= b_{0i} + b_1 \cdot \text{motiv}_{ij} + \epsilon_{ij} \\
\text{Level 2 (school):}&amp; \\
b_{0i} &amp;= \gamma_{00} + \zeta_{0i} \\
\end{align}
\]</span> If we consider one of our schools (e.g.&nbsp;“Dyce Academy”) we can see that our model predicts that this school has higher grades than most other schools (<a href="#fig-ri_1school">Figure&nbsp;3</a>). We can see how this is modelled as a deviation <span class="math inline">\(\zeta_{0\text{DA}}\)</span> (DA for Dyce Academy) from some fixed value <span class="math inline">\(\gamma_{00}\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-ri_1school" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01b_lmm_files/figure-html/fig-ri_1school-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Fitted values from a multilevel model with random intercepts for schools</figcaption>
</figure>
</div>
</div>
</div>
<p>TODO PANEL PLOT</p>
<p>At this point, you might be wondering how this is any different from simply fitting clusters as an additional predictor in a single level regression (i.e.&nbsp;a clusters-as-fixed-effect approach of <code>lm(grade ~ motiv + schoolid)</code>). This would also estimate an difference for each cluster?</p>
<div class="sticky">
<p>The key to the multilevel model is that we are not actually estimating the cluster-specific differences themselves (although we can_ get these out). We are estimating a <strong>distribution</strong> of differences.</p>
</div>
<p>Specifically, the parameters of the multilevel model that are being estimated are the mean and <em>variance</em> of a <em>normal</em> distribution of clusters.</p>
<p>So the parameters that are estimated from our model with a random intercept by-schools, are:</p>
<p><span class="math display">\[
\begin{align}
\text{For Child }j\text{ in School }i&amp; \\
\text{Level 1 (child):}&amp; \\
\text{grade}_{ij} &amp;= b_{0i} + b_1 \cdot \text{motiv}_{ij} + \epsilon_{ij} \\
\text{Level 2 (school):}&amp; \\
b_{0i} &amp;= \gamma_{00} + \zeta_{0i} \\
\text{where: }&amp; \\
&amp;\varepsilon_{ij} \sim N(0,\sigma_\varepsilon) \\
&amp;\zeta_{0i} \sim N(0,\sigma_0) \\
\end{align}
\]</span></p>
<ul>
<li>a fixed intercept <span class="math inline">\(\gamma_{00}\)</span><br>
</li>
<li>the variance with which schools deviate from the fixed intercept <span class="math inline">\(\sigma_0\)</span><br>
</li>
<li>a fixed slope for <code>motiv</code> <span class="math inline">\(b_1\)</span><br>
</li>
<li>(and we also get the residual variance too, in <span class="math inline">\(\sigma_\varepsilon\)</span>)</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="01b_lmm_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="random-slopes" class="level2">
<h2 class="anchored" data-anchor-id="random-slopes">random slopes</h2>
<p><span class="math display">\[
\begin{align}
\text{For observation }j&amp;\text{ in cluster }i \\
\text{Level 1:}&amp; \\
y_{ij} &amp;= b_{0i} + b_{1i} \cdot x_{ij} + \epsilon_{ij} \\
\text{Level 2:}&amp; \\
b_{0i} &amp;= \gamma_{00} + \zeta_{0i} \\
b_{1i} &amp;= \gamma_{10} + \zeta_{1i} \\
\end{align}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="01b_lmm_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>intercepts vary slopes vary</p>
<p>TODO PANEL PLOT</p>
</section>
<section id="partial-pooling" class="level2">
<h2 class="anchored" data-anchor-id="partial-pooling">partial pooling</h2>
<p>It’s tempting to think that we could get the fixed intercept <span class="math inline">\(\gamma_{00}\)</span> by calculating a simple linear model for each school and taking the average intercept. However, the multilevel model is more clever than that. The amount by which Each cluster in a multilevel model contributes to the estimate of the fixed intercept by an amount that depends on:</p>
<ol type="a">
<li>how much between-cluster variation there is relative to within-cluster variation (TODO if clusters are very distinct )</li>
<li>the number of observations in each cluster</li>
</ol>
<p>This is a really useful feature, because it means that we</p>
<p>less data and, when clusters are quite similar/less distinct, then they contribute similar amounts</p>
<ul>
<li>socialist vs liberal analogy?</li>
</ul>
<p>how/why does it do this? by modelling a distribution of lines</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="01b_lmm_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: how does it work?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math display">\[
\frac{\sigma^2_{b} }{\sigma^2_b + \frac{\sigma^2_e }{n_i}}
\]</span></p>
<p>This means that the fixed center of this distribution (the <span class="math inline">\(\gamma_00\)</span>) However,</p>
<p>TODO - what defines the amount to which a cluster contributes to the fixed estimate?<br>
how do far away/few n clusters influence the estimate?</p>
<p>in the multilevel modelling approach, each school gets its own intercept and slope, but these ‘borrow strength’ from the others.</p>
<p>The borrowing of strength is more apparent for the (what would be) more extreme clusters, as well as those that have fewer datapoints. What happens to these cluster estimates is that they are shrunk towards the population average.</p>
<p><span class="math inline">\(\frac{\sigma^2_{b} }{\sigma^2_b + \frac{\sigma^2_e }{n_i}}\)</span></p>
<p>more shrinkage when: - smaller n_j - when within var is large relative to between var - both of these are basically ‘when we have less information about that group’</p>
<p>https://jeanettemumford.org/MixedModelSeries/v4-introduction-to-regularization-in-mixed-models.html#introduction-2</p>
<p>https://jeanettemumford.org/MixedModelSeries/v5-conditional-modes-vs-means.html#the-equation-for-shrinkage</p>
</div>
</div>
</div>
</section>
</section>
<section id="fitting-multilevel-models-in-r" class="level1">
<h1>fitting multilevel models in R</h1>
<p>fixed estimates = average cluster</p>
<p>lme4 lmer</p>
<p><em>what</em> are the model parameters? i.e.&nbsp;variance components.</p>
<p>eq with model params coloured</p>
<p>we <em>can</em> get out estimates of the specific group-lines if we want, but really the model is estimating the variances.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
terminology: fixed effects, random effects, variance components
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>we often use “random effects” to just mean the distribution of random deviations. i.e.&nbsp;</p>
<p>sometimes you might hear “random effect of group” “random effect for group” “random effect [of x] by group”</p>
<p>generally, people are referring to the <code>(1 + ... | cluster)</code> bit.</p>
<p>graphic on how to read it.</p>
<p>intercept &gt;&gt; 1 slope of x &gt;&gt; x | &gt;&gt; varies by these groups &gt;&gt; cluster</p>
<p>a common stumbling block. “effect of x varies by cluster” is not the same as “x varies by cluster”.</p>
</div>
</div>
</div>
<section id="model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="model-parameters">model parameters</h2>
<p><em>what</em> are the model parameters? i.e.&nbsp;variance components.</p>
<p>eq with model params coloured $$</p>
<p>$$</p>
</section>
<section id="cluster-predictions" class="level2">
<h2 class="anchored" data-anchor-id="cluster-predictions">cluster predictions</h2>
<p>ranef</p>
<p>fixef + ranef = coef</p>
<p>dotplot.ranef.mer</p>
</section>
</section>
<section id="model-estimation" class="level1">
<h1>model estimation</h1>
<section id="ml-and-reml" class="level2">
<h2 class="anchored" data-anchor-id="ml-and-reml">ML and REML</h2>
<p>MLE explainer</p>
<ul>
<li>problem for lmm est fix &gt; est varcorr &gt; est fix &gt; est varcorr est of varcorr assumes fixed effects are known. this biases var ests to be slightly smaller<br>
a bit like n-1 in formula for sd</li>
</ul>
<p>REML - OLS to partial out fixef &gt; est varcorr &gt; est varcorr &gt; est varcorr &gt; use GLS to est fixef - in the estimation of varcorr, the fixed effects are 0 <em>by definition</em></p>
</section>
<section id="convergence-issues" class="level2">
<h2 class="anchored" data-anchor-id="convergence-issues">convergence issues</h2>
<p>convergence warnings, singular fits</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Some books use “cluster <span class="math inline">\(j\)</span> &gt;&gt; observation <span class="math inline">\(i\)</span>”, others use “cluster <span class="math inline">\(i\)</span> &gt;&gt; observation <span class="math inline">\(j\)</span>”. We use the latter here<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">© Copyright 2019-2023 <a href="https://www.ed.ac.uk/">The University of Edinburgh</a>. Site licensed under the <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU AGPLv3</a> license.</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>